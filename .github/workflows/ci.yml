name: ci-cuttlefish

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  boot-cuttlefish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add Android SDK to PATH
        run: echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH

      - name: Get Cuttlefish version
        id: get-cf-version
        run: |
          CF_VERSION=$(curl -sL https://api.github.com/repos/google/android-cuttlefish/releases/latest | jq -r '.tag_name')
          echo "CF_VERSION=$CF_VERSION" >> $GITHUB_OUTPUT
          echo "Cuttlefish version: $CF_VERSION"

      - name: Cache Cuttlefish packages
        id: cache-cf-packages
        uses: actions/cache@v4
        with:
          path: ~/cuttlefish-packages
          key: cuttlefish-packages-${{ steps.get-cf-version.outputs.CF_VERSION }}

      - name: Build Cuttlefish packages
        if: steps.cache-cf-packages.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y git devscripts equivs config-package-dev debhelper-compat golang curl
          
          git clone https://github.com/google/android-cuttlefish
          cd android-cuttlefish
          git checkout ${{ steps.get-cf-version.outputs.CF_VERSION }}
          tools/buildutils/build_packages.sh
          
          mkdir -p ~/cuttlefish-packages
          cp cuttlefish-base_*_*64.deb ~/cuttlefish-packages/

      - name: Install Cuttlefish packages
        run: |
          sudo dpkg -i ~/cuttlefish-packages/cuttlefish-base_*_*64.deb || sudo apt-get install -f -y
          
          # Setup KVM permissions
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger
          
          # Add user to groups
          sudo usermod -aG kvm,cvdnetwork,render $USER

      - name: Setup Android SDK tools
        run: |
          # Accept licenses and ensure platform-tools are ready
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null || true
          
          # Start ADB server
          adb kill-server || true
          adb start-server

      - name: Download Cuttlefish system images
        id: get-build-id
        run: |
          # Setup working directory
          export CF_HOME=$HOME/cuttlefish
          mkdir -p $CF_HOME
          
          # Download latest stable Cuttlefish images (API 35)
          BRANCH='aosp-android-latest-release'
          DEVICE='aosp_cf_x86_64_only_phone'
          TARGET="${DEVICE}-userdebug"
          
          echo "Fetching build ID for $TARGET from branch $BRANCH..."
          BUILD_ID=$(curl -sL "https://ci.android.com/builds/branches/${BRANCH}/status.json" | \
            jq -r ".targets[] | select(.name == \"$TARGET\") | .last_known_good_build")
          
          echo "Build ID: $BUILD_ID"
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "CF_HOME=$CF_HOME" >> $GITHUB_ENV

      - name: Cache Cuttlefish images
        id: cache-cuttlefish
        uses: actions/cache@v4
        with:
          path: |
            ~/cuttlefish-downloads
          key: cuttlefish-${{ steps.get-build-id.outputs.BUILD_ID }}

      - name: Download and extract Cuttlefish images
        if: steps.cache-cuttlefish.outputs.cache-hit != 'true'
        run: |
          DEVICE='aosp_cf_x86_64_only_phone'
          TARGET="${DEVICE}-userdebug"
          
          echo "Downloading build $BUILD_ID..."
          SYS_IMG_URL="https://ci.android.com/builds/submitted/${BUILD_ID}/${TARGET}/latest/raw/${DEVICE}-img-${BUILD_ID}.zip"
          HOST_PKG_URL="https://ci.android.com/builds/submitted/${BUILD_ID}/${TARGET}/latest/raw/cvd-host_package.tar.gz"
          
          mkdir -p ~/cuttlefish-downloads
          
          echo "Downloading system images..."
          curl -L "$SYS_IMG_URL" -o ~/cuttlefish-downloads/aosp_cf_phone-img.zip
          
          echo "Downloading host package..."
          curl -L "$HOST_PKG_URL" -o ~/cuttlefish-downloads/cvd-host_package.tar.gz

      - name: Extract Cuttlefish images
        run: |
          echo "Extracting files..."
          tar xzf ~/cuttlefish-downloads/cvd-host_package.tar.gz -C $CF_HOME
          unzip -q ~/cuttlefish-downloads/aosp_cf_phone-img.zip -d $CF_HOME

      - name: Launch Cuttlefish emulator
        run: |
          # Launch Cuttlefish with reasonable settings for CI
          # Use sg to run with proper group permissions
          sg kvm -c "sg cvdnetwork -c 'HOME=$CF_HOME $CF_HOME/bin/launch_cvd \
            -daemon \
            -enable_sandbox=false \
            -memory_mb=8192 \
            -cpus=$(nproc) \
            -report_anonymous_usage_stats=n \
            -resume=false'"
          
          # Wait for device to boot
          echo "Waiting for device to boot..."
          adb wait-for-device
          
          # Wait for boot to complete
          timeout 600 bash -c '
            while true; do
              BOOT_COMPLETE=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d "\r")
              if [ "$BOOT_COMPLETE" = "1" ]; then
                echo "Device booted successfully!"
                break
              fi
              echo "Waiting for boot completion..."
              sleep 5
            done
          '

      - name: Verify emulator
        run: |
          echo "Device information:"
          adb shell getprop ro.build.version.release
          adb shell getprop ro.build.version.sdk
          adb shell getprop ro.product.model
          adb shell getprop ro.product.device
          
          echo ""
          echo "Device list:"
          adb devices -l
          
          echo ""
          echo "Taking screenshot..."
          mkdir -p screenshots
          adb exec-out screencap -p > screenshots/emulator-screenshot.png

      - name: Upload screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-screenshot
          path: screenshots/emulator-screenshot.png
          retention-days: 30

      - name: Stop Cuttlefish emulator
        if: always()
        run: |
          sg kvm -c "sg cvdnetwork -c 'HOME=$CF_HOME $CF_HOME/bin/stop_cvd'" || true
