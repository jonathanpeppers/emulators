name: ci-cuttlefish

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  boot-cuttlefish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add Android SDK to PATH
        run: echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH

      - name: Setup Cuttlefish environment
        run: |
          # Install Cuttlefish base package
          curl -LO https://github.com/topjohnwu/magisk-files/releases/download/files/cuttlefish-base_1.2.0_amd64.deb
          sudo apt-get update
          sudo dpkg -i ./cuttlefish-base_*_*64.deb || sudo apt-get install -f -y
          rm cuttlefish-base_*_*64.deb
          
          # Setup KVM permissions
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger
          sudo usermod -aG kvm,cvdnetwork,render $USER

      - name: Setup Android SDK tools
        run: |
          # Accept licenses and ensure platform-tools are ready
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null || true
          
          # Start ADB server
          adb kill-server || true
          adb start-server

      - name: Download Cuttlefish system images
        run: |
          # Setup working directory
          export CF_HOME=$HOME/cuttlefish
          mkdir -p $CF_HOME
          
          # Download latest stable Cuttlefish images (API 35)
          BRANCH='aosp-android-latest-release'
          DEVICE='aosp_cf_x86_64_only_phone'
          TARGET="${DEVICE}-userdebug"
          
          echo "Fetching build ID for $TARGET from branch $BRANCH..."
          BUILD_ID=$(curl -sL "https://ci.android.com/builds/branches/${BRANCH}/status.json" | \
            jq -r ".targets[] | select(.name == \"$TARGET\") | .last_known_good_build")
          
          echo "Downloading build $BUILD_ID..."
          SYS_IMG_URL="https://ci.android.com/builds/submitted/${BUILD_ID}/${TARGET}/latest/raw/${DEVICE}-img-${BUILD_ID}.zip"
          HOST_PKG_URL="https://ci.android.com/builds/submitted/${BUILD_ID}/${TARGET}/latest/raw/cvd-host_package.tar.gz"
          
          echo "Downloading system images..."
          curl -L "$SYS_IMG_URL" -o aosp_cf_phone-img.zip
          
          echo "Downloading host package..."
          curl -L "$HOST_PKG_URL" -o cvd-host_package.tar.gz
          
          echo "Extracting files..."
          tar xzf cvd-host_package.tar.gz -C $CF_HOME
          unzip -q aosp_cf_phone-img.zip -d $CF_HOME
          
          # Cleanup downloads
          rm -f cvd-host_package.tar.gz aosp_cf_phone-img.zip
          
          echo "CF_HOME=$CF_HOME" >> $GITHUB_ENV

      - name: Launch Cuttlefish emulator
        run: |
          # Launch Cuttlefish with reasonable settings for CI
          HOME=$CF_HOME $CF_HOME/bin/launch_cvd \
            -daemon \
            -enable_sandbox=false \
            -memory_mb=8192 \
            -cpus=$(nproc) \
            -report_anonymous_usage_stats=n \
            -resume=false
          
          # Wait for device to boot
          echo "Waiting for device to boot..."
          adb wait-for-device
          
          # Wait for boot to complete
          timeout 600 bash -c '
            while true; do
              BOOT_COMPLETE=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d "\r")
              if [ "$BOOT_COMPLETE" = "1" ]; then
                echo "Device booted successfully!"
                break
              fi
              echo "Waiting for boot completion..."
              sleep 5
            done
          '

      - name: Verify emulator
        run: |
          echo "Device information:"
          adb shell getprop ro.build.version.release
          adb shell getprop ro.build.version.sdk
          adb shell getprop ro.product.model
          adb shell getprop ro.product.device
          
          echo ""
          echo "Device list:"
          adb devices -l

      - name: Stop Cuttlefish emulator
        if: always()
        run: |
          HOME=$CF_HOME $CF_HOME/bin/stop_cvd || true
